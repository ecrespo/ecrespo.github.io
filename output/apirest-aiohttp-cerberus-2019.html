<!doctype html>
<html lang="es" itemscope itemtype="http://schema.org/Person">
<head>
            <meta charset="utf-8">
        <!-- Site Meta Data -->
        <title>Validando un API rest asíncrono con Cerberus</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="Ernesto Crespo">

        <link rel="shortcut icon" href="">

        <!-- schema.org -->
        <meta itemprop="name" content="Página de Seraph">
        <meta itemprop="image" content="">
        <meta itemprop="description" content="">

        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,600,700' rel='stylesheet' type='text/css'>
        <!-- Style Meta Data -->
        <link rel="stylesheet" href="https://ecrespo.github.io/theme/css/style.css" type="text/css"/>
        <link rel="stylesheet" href="https://ecrespo.github.io/theme/css/pygments.css" type="text/css"/>

        <!-- Feed Meta Data -->
            <link href="https://ecrespo.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
                  title="Página de Seraph ATOM Feed"/>

        <!-- Twitter Feed -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="">
        <meta name="twitter:image" content="">

    <meta name="twitter:creator" content="">
    <meta name="twitter:url" content="https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html">
    <meta name="twitter:title" content="Página de Seraph ~ Validando un API rest asíncrono con Cerberus">
    <meta name="twitter:description" content="Se creará un API rest asíncrono (usando aiohttp), donde se valida la entrada con cerberus">

    <!-- Facebook Meta Data -->
    <meta property="og:title" content="Página de Seraph ~ Validando un API rest asíncrono con Cerberus"/>
    <meta property="og:description" content="Se creará un API rest asíncrono (usando aiohttp), donde se valida la entrada con cerberus"/>
    <meta property="og:image" content=""/>
</head>

<body>
<!-- Sidebar -->
<aside>
    <!--<center><a href="https://ecrespo.github.io"><img id="avatar" src=""></a></center>-->
    <h1>Página de Seraph</h1>
    <br>


    <nav class="nav">
        <ul class="list-bare">

                <li><a class="nav__link" href="/archives.html">Archives</a></li>
                <li><a class="nav__link" href="/categories.html">Categories</a></li>
                <li><a class="nav__link" href="/tags.html">Tags</a></li>

                <li><a class="nav__link" href="https://ecrespo.github.io/pages/About.html">Acerca</a></li>
                <li><a class="nav__link" href="https://ecrespo.github.io/pages/Contacto.html">Contacto</a></li>

        </ul>
    </nav>

    <p class="social">
                <a href="https://medium.com/@_seraph1" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/medium.png"></a>
                <a href="http://ve.linkedin.com/in/ernestocrespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/linkedin.png"></a>
                <a href="https://github.com/ecrespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/github.png"></a>
                <a href="https://google.com/+ErnestoCrespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/google.png"></a>
                <a href="https://twitter.com/_seraph1" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/twitter.png"></a>
                <a href="https://www.facebook.com/ernesto.crespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/facebook.png"></a>
                <a href="https://gitlab.com/ecrespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/gitlab.png"></a>
                <a href="https://soundcloud.com/ernesto-crespo" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/soundcloud.png"></a>
                <a href="//www.seraph.to/feeds/all.atom.xml" target="_blank"><img
                        src="https://ecrespo.github.io/theme/images/icons/rss.png"></a>
            <a href="https://ecrespo.github.io/feeds/all.atom.xml" rel="alternate">
                <img src="https://ecrespo.github.io/theme/images/icons/rss.png"></a>
    </p>

        <h2>Categories</h2>
        <ul class="navbar">
                <li><a
                        href="https://ecrespo.github.io/category/accesibilidad.html">Accesibilidad</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/anuncio.html">Anuncio</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/anuncios.html">Anuncios</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/aplicacion-android.html">Aplicación Android</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/asterisk-debian-linux.html">Asterisk, Debian, Linux</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/charla.html">Charla</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/charla-python.html">Charla Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/debian-linux-mac-book.html">Debian, Linux, Mac Book</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/debian-maemo-nokia-n810-python.html">Debian, maemo, Nokia N810, Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/demostracion-aplicacion-para-android.html">Demostración Aplicación para Android</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/desarrollomovil.html">Desarrollo,Movil</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/evento.html">Evento</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/general.html">General</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/linux.html">Linux</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/linuxdebian.html">Linux,Debian</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/linuxdesarrollo.html">Linux,Desarrollo</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/linuxempaquetado.html">Linux,Empaquetado</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/linuxofimaticadesarrollo.html">Linux,Ofimatica,Desarrollo</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/movil-nokia.html">Movil, Nokia</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/nokia-n810.html">Nokia N810</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/nokia-n810-debian-maemo.html">Nokia N810 Debian Maemo</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/posts.html">posts</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/resumen-2010.html">Resumen 2010</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/sistemas-operativos.html">Sistemas Operativos</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial.html">Tutorial</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-android.html">Tutorial Android</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-arduino.html">Tutorial de Arduino</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-data-science.html">Tutorial de Data Science</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-docker.html">Tutorial de Docker</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-integracion-continua.html">Tutorial de integración continua</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-linux.html">Tutorial de Linux</a></li>
                <li class="active"><a
                        href="https://ecrespo.github.io/category/tutorial-de-python.html">Tutorial de Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-python-en-android.html">Tutorial de Python en Android</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-python-y-linux.html">Tutorial de Python y Linux</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-de-python-y-pyqt.html">Tutorial de Python y PyQt</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-debian-bsd-y-python.html">Tutorial Debian BSD y Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-linux.html">Tutorial Linux</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-linux-y-python.html">Tutorial Linux y Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-python.html">Tutorial Python</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-python-en-android.html">Tutorial Python en Android</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorial-python-y-linux.html">Tutorial Python y Linux</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/tutorialdesarrollo.html">Tutorial,Desarrollo</a></li>
                <li><a
                        href="https://ecrespo.github.io/category/xml-rpcpython.html">XML-RPC,Python</a></li>
        </ul>


</aside>

<!-- Content -->
<article>
    <section id="content">
        <article>
            <h2 class="post_title post_detail"><a href="https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html" rel="bookmark"
                                                  title="Permalink to Validando un API rest asíncrono con Cerberus">Validando un API rest asíncrono con Cerberus</a></h2>
            <div class="entry-content blog-post">
                <p>En este artículo se mostrará como crear un API rest asincrono usando aiohttp, se usará un script para acceder a la base de datos NoSQL RethinkDB de manera asíncrona,
y 2 formas de validar la entrada de datos del API, la primera evaluando cada variable, la segunda se usará cerberus donde se tiene un esquema de la entrada de datos y
por último la tercera, usará cerberus pero el esquema estará guardado en rethinkdb.</p>
<p>El repositorio del código completo de este tutorial se encuentra en <a href="https://gitlab.com/ecrespo/async-api-rest-example/tree/master">github</a>.</p>
<p>Este artículo se basa en el artículo <a href="https://www.ecalamia.com/blog/data-validation-robust-apis/">Using Data Validation for Robust APIs</a> y en el
artículo <a href="https://blog.apcelent.com/create-rest-api-using-aiohttp.html">How to create REST API using aiohttp</a>, donde se explica como hacer un API rest sincrónico con aiohttp.</p>
<p>La documentación de cerberus la pueden ver en el siguiente <a href="https://cerberus-sanhe.readthedocs.io/usage.html">cerberus</a>.</p>
<p>Se tiene la siguiente estructura de directorios y archivos del API rest:</p>
<div class="highlight"><pre><span></span><code><span class="err">async-api-rest-example</span>
<span class="err">├── app.py</span>
<span class="err">├── README.md</span>
<span class="err">├── resources</span>
<span class="err">│   ├── api_resources.py</span>
<span class="err">│   ├── home.py</span>
<span class="err">│   ├── __init__.py</span>
<span class="err">│   └── rethink_async.py</span>
<span class="err">└── run.py</span>
</code></pre></div>

<p>Descripción de los archivos:</p>
<ul>
<li>app.py: Se definen las rutas de los endpoint del API rest.</li>
<li>run.py: Script que permite correr el API rest.</li>
<li>resources/rethin_async.py: Módulo que permite acceder de manera asíncrona a rethinkdb.</li>
<li>resources/home.py: Página de inicio del API rest.</li>
<li>resources/api_resources.py: Donde se define los métodos HTTP del API rest.</li>
</ul>
<h3>Script run.py</h3>
<p>Este script permite iniciar el API rest, a continuación el código:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>

<span class="c1">#Se importa aiohttp</span>
<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>

<span class="c1">#Se importa las rutas de los endpoint</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">setup_routes</span>



<span class="k">async</span> <span class="k">def</span> <span class="nf">init_app</span><span class="p">():</span>
    <span class="c1">#Se instancia la aplicación</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
    <span class="c1">#A la aplicación se le pasa las rutas</span>
    <span class="n">setup_routes</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="c1">#Se retorna la aplicación</span>
    <span class="k">return</span> <span class="n">app</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1">#Se define la dirección del host, el puerto y se corre la Ap en dicha IP y puerto</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;0.0.0.0&#39;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="mi">5000</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">init_app</span><span class="p">()</span>

    <span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<h3>Script app.py</h3>
<p>Este script define las rutas y URLs de los endpoint del API rest. A continuación el código:</p>
<div class="highlight"><pre><span></span><code><span class="c1">#Se importa los recursos del api rest y el home .</span>
<span class="kn">from</span> <span class="nn">resources.api_resources</span> <span class="kn">import</span> <span class="n">Student</span>
<span class="kn">from</span> <span class="nn">resources.home</span> <span class="kn">import</span> <span class="n">getIndex</span>





<span class="k">def</span> <span class="nf">setup_routes</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
    <span class="n">student</span> <span class="o">=</span> <span class="n">Student</span><span class="p">()</span>
    <span class="c1">#Se tiene 3 endpoints, el primero validación clásica,</span>
    <span class="c1"># el segundo validando con cerberus, y el 3ero con cerberus</span>
    <span class="c1">#pero guardando el esquema de validación en una base de datos</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s1">&#39;/api/v1/student1&#39;</span><span class="p">,</span><span class="n">student</span><span class="o">.</span><span class="n">getData1</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s1">&#39;/api/v1/student2&#39;</span><span class="p">,</span><span class="n">student</span><span class="o">.</span><span class="n">getData2</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_post</span><span class="p">(</span><span class="s1">&#39;/api/v1/student3&#39;</span><span class="p">,</span><span class="n">student</span><span class="o">.</span><span class="n">getData3</span><span class="p">)</span>
    <span class="c1">#Por seguridad no se permite ingresar a la raiz del API rest</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/api/v1/&#39;</span><span class="p">,</span> <span class="n">getIndex</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">router</span><span class="o">.</span><span class="n">add_get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">getIndex</span><span class="p">)</span>
</code></pre></div>

<h3>Script rethink_async.py</h3>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python3</span>

<span class="kn">import</span> <span class="nn">rethinkdb</span> <span class="k">as</span> <span class="nn">r</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>


<span class="n">r</span><span class="o">.</span><span class="n">set_loop_type</span><span class="p">(</span><span class="s2">&quot;asyncio&quot;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">createDB</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create DB to database server.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to create</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">database</span> <span class="ow">not</span> <span class="ow">in</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db_list</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db_create</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>



<span class="k">async</span> <span class="k">def</span> <span class="nf">createTable</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Table in database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table_create</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">listdb</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all database in database server.</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db_list</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">listtables</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Lista tables from database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to list tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table_list</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert dictionary  in table.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    table: table to insert Dictionary</span>
<span class="sd">    data: Dictionary data to insert</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>




<span class="k">async</span> <span class="k">def</span> <span class="nf">getAll</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get All documents from pattern search</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    table: table name to search</span>
<span class="sd">    pattern: Dictionary with pattern search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">while</span> <span class="p">(</span><span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">()):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">elements</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">getFirst</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">pattern</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get first document from pattern search</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    table: table name to search</span>
<span class="sd">    pattern: Dictionary with pattern search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="k">await</span>  <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">while</span> <span class="p">(</span><span class="k">await</span>  <span class="n">cursor</span><span class="o">.</span><span class="n">fetch_next</span><span class="p">()):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">cursor</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
        <span class="n">elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">break</span>
    <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">elements</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a  document from pattern search</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    table: table name to search</span>
<span class="sd">    pattern: Dictionary with pattern search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span>  <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">server</span><span class="p">,</span><span class="n">port</span><span class="p">,</span><span class="n">database</span><span class="p">,</span><span class="n">table</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">pattern</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update a document from pattern search</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    server: IP server to connect</span>
<span class="sd">    port: Port server to connect</span>
<span class="sd">    database: Database name to connect</span>
<span class="sd">    table: table name to search</span>
<span class="sd">    pattern: Dictionary with pattern search</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="nb">dict</span><span class="p">())):</span>
        <span class="k">if</span> <span class="n">pattern</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="k">await</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="p">(</span><span class="n">database</span><span class="p">)</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3>Script api_resouces.py</h3>
<p>En el script se tienen 3 métodos:</p>
<ul>
<li>getData1: Este método válida cada una de las entrada de datos.</li>
<li>getData2: Este método válida la entrada de datos con un esquema validando con cerberus.</li>
<li>getData3: Este método vuelve a usar cerberus pero ahora tomando el esquema a validar usando rethinkdb.</li>
</ul>
<p>A continuación se muestra el código:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>
<span class="kn">from</span> <span class="nn">cerberus</span> <span class="kn">import</span> <span class="n">Validator</span>
<span class="kn">import</span> <span class="nn">rethinkdb</span> <span class="k">as</span> <span class="nn">r</span>

<span class="kn">from</span> <span class="nn">.rethink_async</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">__version__</span> <span class="o">=</span> <span class="s1">&#39;0.0.1&#39;</span>


<span class="n">student_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maxlength&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s1">&#39;grade&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;required&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
        <span class="s1">&#39;allowed&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">getData1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>

        <span class="c1">#Se convierte el json a un diccionario</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Ill-formed JSON&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Se valida los datos de entrada</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Expecting uid:int&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">age</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="mi">18</span> <span class="o">&lt;</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="mi">35</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Bad age&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Expecting age:int within the range [18:35]&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Max limit 50&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Expecting name:str within the range [0:50]&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">grade</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">grade</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grade</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span>
            <span class="k">if</span> <span class="n">grade</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">):</span>
                <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;A, B or C expected&quot;</span><span class="p">}</span>
                <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Expecting grade:str A, B or C expected&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Luego de validar se construye el diccionario de salida de datos como json</span>

        <span class="n">data_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

        <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data_output</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>



    <span class="k">async</span> <span class="k">def</span> <span class="nf">getData2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>

        <span class="c1">#Se convierte el json del post en un diccionario</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Ill-formed JSON&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Con la variable que contiene el esquema se realiza la validación del json</span>
        <span class="n">student_validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span><span class="n">student_schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student_validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">student_validator</span><span class="o">.</span><span class="n">errors</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Se construye el diccionario de la salida de los datos vía json</span>
        <span class="n">data_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

        <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data_output</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>


    <span class="k">async</span> <span class="k">def</span> <span class="nf">getData3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>

        <span class="c1">#Se convierte el json en un diccionario</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="s2">&quot;Ill-formed JSON&quot;</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Si yo se, no debería tener  la configuración de la base de datos acá,</span>
        <span class="c1">#pero era para no alargar el código de ejemplo</span>
        <span class="c1">#Se definen el servidor, puerto, base de datos, la tabla y el patrón de busqueda</span>
        <span class="n">server</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="mi">28015</span>
        <span class="n">db</span> <span class="o">=</span> <span class="s2">&quot;student&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="s2">&quot;student_schema&quot;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;endpoint&quot;</span><span class="p">:</span> <span class="s2">&quot;student3&quot;</span><span class="p">}</span>

        <span class="c1">#Se realiza la consulta a rethinkdb de manera asincrona</span>
        <span class="n">student_schemadb</span> <span class="o">=</span> <span class="k">await</span> <span class="n">getFirst</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>

        <span class="c1">#Se quitan del diccionario el id y el endpoint a fin de realizar la evaluación del esquema</span>
        <span class="n">student_schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">student_schemadb</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">student_schemadb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="s1">&#39;id&#39;</span><span class="p">}</span>
        <span class="n">student_schema</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">:</span> <span class="n">student_schema</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">student_schema</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="s1">&#39;endpoint&#39;</span><span class="p">}</span>

        <span class="c1">#Se valida el esquema con los datos suministrados vía post</span>
        <span class="n">student_validator</span> <span class="o">=</span> <span class="n">Validator</span><span class="p">(</span><span class="n">student_schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">student_validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">student_validator</span><span class="o">.</span><span class="n">errors</span>
            <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;reason&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">205</span><span class="p">)</span>

        <span class="c1">#Se toman los datos y se colocan en el diccionario para el json de salida</span>
        <span class="n">data_output</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="n">data_output</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="s1">&#39;A&#39;</span><span class="p">)</span>

        <span class="n">response_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">data_output</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_obj</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
</code></pre></div>

<h3>Base de datos rethinkdb con el esquema para cerberus</h3>
<p>Para que el método getData3 funcione es necesario tener almacenado en la base de datos rethinkdb el esquema.</p>
<p>El proceso de instalación de rethinkDB vía docker, se deja en el siguiente <a href="https://platzi.com/blog/como-instalar-rethinkdb-docker/">artículo de platzi</a>.</p>
<p>Para insertar los datos se ejecuta en el dashboard de rethinkDB (http://localhost:8080) el siguiente comando:</p>
<div class="highlight"><pre><span></span><code><span class="err">r.db(&quot;student&quot;).table(&quot;student_schema&quot;).insert({id:1,endpoint: &#39;student3&#39;,uid: {</span>
<span class="err">        &#39;required&#39;: true,</span>
<span class="err">        &#39;type&#39;: &#39;integer&#39;},</span>
<span class="err">    age: {</span>
<span class="err">        &#39;required&#39;: true,</span>
<span class="err">        &#39;type&#39;: &#39;integer&#39;,</span>
<span class="err">        &#39;min&#39;: 18,</span>
<span class="err">        &#39;max&#39;: 35</span>
<span class="err">    },</span>
<span class="err">    name: {</span>
<span class="err">        &#39;required&#39;: true,</span>
<span class="err">        &#39;type&#39;: &#39;string&#39;,</span>
<span class="err">        &#39;maxlength&#39;: 50</span>
<span class="err">    },</span>
<span class="err">    grade: {</span>
<span class="err">        &#39;required&#39;: false,</span>
<span class="err">        &#39;type&#39;: &#39;string&#39;,</span>
<span class="err">        &#39;allowed&#39;: [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]</span>
<span class="err">  }})</span>
</code></pre></div>

<p>De esa forma se inserta los datos en la tabla.</p>
<p>Para consultar la tabla vía dashboard se ejecuta:</p>
<div class="highlight"><pre><span></span><code><span class="err">r.db(&quot;student&quot;).table(&quot;student_schema&quot;)</span>
</code></pre></div>

<p>A continuación se muestra la tabla:</p>
<p><img alt="Tabla esquema" src="./images/2019-apirest-cerberus-5.png"></p>
<h3>Iniciar el API rest.</h3>
<p>Para iniciar el API rest se tiene que tener instalado la librería rethinkdb y aiohttp:</p>
<div class="highlight"><pre><span></span><code><span class="err">pip install rethinkdb aiohttp</span>
</code></pre></div>

<p>Luego de instalada se ejecuta el script run.py:</p>
<div class="highlight"><pre><span></span><code><span class="err">python run.py</span>
</code></pre></div>

<p>Si se tiene la siguiente salida el API rest está corriendo sin problemas:</p>
<div class="highlight"><pre><span></span><code><span class="err">======== Running on http://0.0.0.0:5000 ========</span>
<span class="err">(Press CTRL+C to quit)</span>
</code></pre></div>

<h3>Consultas al API rest</h3>
<p>Para consultar el API rest se puede usar insomia o postman, ambos son clientes API rest.</p>
<p>Se tienen 3 endpoint todos vía método post que se le pasará un json como el siguiente:</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
  <span class="nt">&quot;uid&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
  <span class="nt">&quot;age&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
  <span class="nt">&quot;grade&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span>
<span class="p">}</span>
</code></pre></div>

<p>Los urls son los siguientes:</p>
<ul>
<li>http://localhost:5000/api/v1/student1 : Usa el método getData1.</li>
<li>http://localhost:5000/api/v1/student2 : Usa el método getData2.</li>
<li>http://localhost:5000/api/v1/student3 : Usa el método getData3.</li>
</ul>
<p>Primer endpoint:</p>
<p>Se realiza la consulta con el json mostrado anteriormente:</p>
<p><img alt="Consulta válida" src="./images/2019-apirest-cerberus-1.png"></p>
<p>Ahora se modifica por ejemplo la variable grade a X:</p>
<p><img alt="Consulta inválida" src="./images/2019-apirest-cerberus-2.png"></p>
<p>En este caso el valor X para la variable grade no es válido.</p>
<p>Segundo endpoint:</p>
<p>En este caso se usa cerberus y la variable que contiene el esquema para validar:</p>
<p>Se realiza la consulta con el json original:</p>
<p><img alt="Consulta válida" src="./images/2019-apirest-cerberus-3.png"></p>
<p>Ahora se realiza la consulta modificando la variable grade con el valor de Z:</p>
<p><img alt="Consulta inválida" src="./images/2019-apirest-cerberus-4.png"></p>
<p>El mensaje es más genérico no es el que se definió en el primer método.</p>
<p>Tercer endpoint:</p>
<p>Acá no se verán cambios significativos en la consulta, lo interesante es que, al tener muchos endpoint con distintas entradas de datos,
lo mejor es usar una base de datos donde se tenga almacenada cada esquema por endpoint.</p>
<p>Así que el resultado sería el mismo que los del segundo endpoint.</p>
<h2></h2>
<p>¡Haz tu donativo!
Si te gustó el artículo puedes realizar un donativo con Bitcoin (BTC)
usando la billetera digital de tu preferencia a la siguiente
dirección: 17MtNybhdkA9GV3UNS6BTwPcuhjXoPrSzV</p>
<p>O Escaneando el código QR desde la billetera:</p>
<p><img alt="17MtNybhdkA9GV3UNS6BTwPcuhjXoPrSzV" src="./images/17MtNybhdkA9GV3UNS6BTwPcuhjXoPrSzV.png"></p>
            </div>
            <div class="post_list">
                <span>By </span>
                <a href="https://ecrespo.github.io/author/ernesto-crespo.html">@Ernesto Crespo</a>
                <span> in </span>
                <span class="post_category"><a href="https://ecrespo.github.io/category/tutorial-de-python.html" rel="bookmark"
                                               title="Permalink to Tutorial de Python">[ Tutorial de Python ]</a></span>
                <span class="post_date">sáb 08 junio 2019</span>
                <div><span>Tags : </span>
                            <span><a href="https://ecrespo.github.io/tag/debian.html">#Debian, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/python.html">#Python, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/aiohttp.html">#aiohttp, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/ubuntu.html">#Ubuntu, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/api-rest.html">#API rest, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/asincrono.html">#asincrono, </a></span>
                            <span><a href="https://ecrespo.github.io/tag/cerberus.html">#Cerberus, </a></span>
                </div>

                <div class="entry-social">
                    <span class="twitter"><a target="_blank" rel="nofollow"
                                             onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;"
                                             title="Twitter"
                                             href="https://twitter.com/share?url=https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html&text=Validando un API rest asíncrono con Cerberus&via="><img
                            src="https://ecrespo.github.io/theme/images/icons/twitter-s.png"></a></span>

                    <span class="gplus"><a target="_blank" title="Google +"
                                           href="https://plus.google.com/share?url=https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html&hl=fr"
                                           rel="nofollow"
                                           onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img
                            src="https://ecrespo.github.io/theme/images/icons/google-s.png"></a></span>

                    <span class="facebook"><a target="_blank" title="Facebook" rel="nofollow"
                                              onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;"
                                              href="https://www.facebook.com/sharer.php?u=https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html&t=Validando un API rest asíncrono con Cerberus"><img
                            src="https://ecrespo.github.io/theme/images/icons/facebook-s.png"></a></span>

                    <a target="_blank" title="Linkedin"
                       href="https://www.linkedin.com/shareArticle?mini=true&url=https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html&title=Validando un API rest asíncrono con Cerberus"
                       rel="nofollow"
                       onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;"><img
                            src="https://ecrespo.github.io/theme/images/icons/linkedin-s.png"></a>

                    <span class="mail"><a
                            href="mailto:?subject=Validando un API rest asíncrono con Cerberus&amp;body=Viens découvrir un article à propos de [Validando un API rest asíncrono con Cerberus] sur le site de Ernesto Crespo. https://ecrespo.github.io/apirest-aiohttp-cerberus-2019.html"
                            title="Share by Email" target="_blank"><img
                            src="https://ecrespo.github.io/theme/images/icons/mail-s.png"></a></span>
                </div>
            </div>
                <div class="comments">
                    <h2>Comments !</h2>
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                        var disqus_identifier = "apirest-aiohttp-cerberus-2019.html";
                        (function () {
                            var dsq = document.createElement('script');
                            dsq.type = 'text/javascript';
                            dsq.async = true;
                            dsq.src = 'https://https://seraphto.disqus.com.disqus.com/embed.js';
                            (document.getElementsByTagName('head')[0] ||
                            document.getElementsByTagName('body')[0]).appendChild(dsq);
                        })();
                    </script>
                </div>
        </article>
    </section>
</article>

<!-- Footer -->
    <footer>
        <p>
            Blog powered by <a href="http://getpelican.com/">Pelican</a>,
            which takes great advantage of <a href="http://python.org">Python</a>.
            Theme <a href="https://github.com/parbhat/pelican-blue">Pelican-Blue</a> by <a
                href="https://parbhatpuri.com/">@parbhat</a>.
        </p>
    </footer>

    <!-- Analytics -->
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-131517246-1']);
        _gaq.push(['_trackPageview']);
        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>

</body>
</html>